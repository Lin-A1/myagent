# 部署指南

## 部署架构

系统采用多层架构设计，包含以下组件：

1. **负载均衡层**: Nginx作为反向代理和负载均衡器
2. **应用服务层**: 多个FastAPI应用实例
3. **数据存储层**: PostgreSQL, Redis, MinIO, Milvus

## 部署方式

### Docker Compose部署（推荐）

项目提供了完整的Docker Compose配置，可以一键部署所有服务：

```bash
# 进入部署目录
cd deployments/docker

# 启动所有服务
./start.sh

# 或者直接使用docker-compose
docker-compose up -d
```

### Kubernetes部署

对于生产环境，建议使用Kubernetes进行部署：

1. 创建Kubernetes集群
2. 部署数据库服务
3. 部署缓存服务
4. 部署对象存储服务
5. 部署向量数据库服务
6. 部署应用服务
7. 配置负载均衡器

## 环境配置

### 环境变量

在生产环境中，需要配置以下环境变量：

```bash
# 数据库配置
DATABASE_URL=postgresql://user:password@postgres:5432/llm_db

# Redis配置
REDIS_URL=redis://redis:6379/0

# MinIO配置
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=your_access_key
MINIO_SECRET_KEY=your_secret_key

# Milvus配置
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530

# OpenAI配置（可选）
OPENAI_API_KEY=your_openai_api_key
OPENAI_API_BASE=https://api.openai.com/v1
```

### SSL证书配置

在生产环境中，建议启用HTTPS：

1. 获取SSL证书
2. 将证书文件放置在`deployments/nginx/certs/`目录下
3. 修改Nginx配置文件启用SSL

## 性能优化

### 应用层优化

1. **负载均衡**: 使用Nginx进行负载均衡，部署多个应用实例
2. **缓存策略**: 合理使用Redis缓存，减少数据库查询
3. **数据库连接池**: 配置合适的数据库连接池大小
4. **异步处理**: 使用异步编程提高并发处理能力

### 数据库优化

1. **索引优化**: 为常用查询字段创建索引
2. **查询优化**: 优化复杂查询，避免N+1查询问题
3. **分库分表**: 对于大数据量场景，考虑分库分表

### 存储优化

1. **MinIO集群**: 部署MinIO集群提高存储性能和可靠性
2. **Milvus集群**: 部署Milvus集群处理大规模向量数据

## 监控和日志

### 监控指标

建议监控以下关键指标：

1. **应用性能**: API响应时间、吞吐量、错误率
2. **系统资源**: CPU使用率、内存使用率、磁盘IO
3. **数据库性能**: 查询响应时间、连接数、缓存命中率
4. **存储性能**: 存储空间使用率、读写性能

### 日志管理

1. **应用日志**: 记录关键业务操作和错误信息
2. **访问日志**: 记录API访问日志，用于分析和安全审计
3. **错误日志**: 记录系统错误和异常信息

推荐使用ELK（Elasticsearch, Logstash, Kibana）或类似的日志管理解决方案。

## 安全配置

### 认证和授权

1. **JWT令牌**: 使用JWT进行用户认证
2. **权限控制**: 实现基于角色的访问控制（RBAC）
3. **API密钥**: 为外部服务提供API密钥认证

### 数据安全

1. **数据加密**: 敏感数据在存储和传输过程中进行加密
2. **访问控制**: 严格控制数据库和存储服务的访问权限
3. **审计日志**: 记录所有数据访问和修改操作

### 网络安全

1. **防火墙**: 配置防火墙规则，限制不必要的端口访问
2. **SSL/TLS**: 启用HTTPS加密传输
3. **DDoS防护**: 配置DDoS防护措施

## 备份和恢复

### 数据备份

1. **数据库备份**: 定期备份PostgreSQL数据库
2. **对象存储备份**: 定期备份MinIO中的重要数据
3. **配置备份**: 备份重要的配置文件和环境变量

### 灾难恢复

1. **备份验证**: 定期验证备份数据的完整性和可恢复性
2. **恢复演练**: 定期进行灾难恢复演练
3. **多地域部署**: 考虑多地域部署提高容灾能力

## 版本升级

### 应用升级

1. **蓝绿部署**: 使用蓝绿部署策略减少停机时间
2. **滚动更新**: 使用Kubernetes的滚动更新功能
3. **回滚机制**: 确保能够快速回滚到上一个稳定版本

### 数据库升级

1. **兼容性检查**: 确保新版本与现有数据兼容
2. **迁移脚本**: 编写数据库迁移脚本
3. **备份验证**: 升级前进行完整备份

## 故障排除

### 常见问题

1. **服务启动失败**
   - 检查容器日志
   - 验证环境变量配置
   - 检查端口占用情况

2. **性能问题**
   - 分析系统资源使用情况
   - 检查数据库查询性能
   - 优化应用代码

3. **数据一致性问题**
   - 检查数据库连接
   - 验证事务处理逻辑
   - 检查缓存一致性

### 支持资源

- 官方文档
- GitHub Issues
- 社区论坛
- 专业支持服务