# 系统架构设计

## 1. 总体架构

本系统采用混合架构设计，结合了单体架构和微服务架构的优势：

- **核心服务层**：采用单体架构，包含LLM核心服务、认证服务等，便于开发和维护
- **扩展服务层**：采用微服务架构，如Agent服务、MCP协议服务等，便于独立扩展
- **数据层**：统一的数据存储和访问层，支持多种存储系统

## 2. 组件详细设计

### 2.1 API网关层
- 基于FastAPI构建
- 负责请求路由、认证、限流等功能
- 完全兼容OpenAI API规范

### 2.2 核心服务层
- **LLM核心服务**：处理大语言模型的核心逻辑
- **认证服务**：用户认证和权限管理
- **存储服务**：统一数据访问接口

### 2.3 数据存储层
- **PostgreSQL**：关系型数据存储
- **Redis**：缓存和会话存储
- **MinIO**：对象存储（文件、图片等）
- **Milvus**：向量数据存储和检索

### 2.4 扩展服务层
- **Agent服务**：智能体服务
- **MCP协议服务**：模型协调协议实现

## 3. 技术栈

- **编程语言**：Python 3.10+
- **Web框架**：FastAPI
- **虚拟环境管理**：uv
- **容器化**：Docker
- **反向代理**：Nginx
- **数据库**：PostgreSQL, Redis, MinIO, Milvus

## 4. 部署架构

```
┌─────────────────────────────────────────────┐
│              Load Balancer                  │
│                   Nginx                     │
└─────────────────────┬───────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──┐   ┌──────▼────┐   ┌────▼──────┐
│  API     │   │  Core     │   │  Agent    │
│  Gateway │   │  Services │   │  Service  │
└───────┬──┘   └──────┬────┘   └────┬──────┘
        │             │             │
        └─────────────┼─────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
┌───────▼──┐   ┌──────▼────┐   ┌────▼──────┐
│PostgreSQL│   │  Redis    │   │  MinIO    │
└──────────┘   └───────────┘   └───────────┘
               ┌───────────┐
               │  Milvus   │
               └───────────┘
```

## 5. 数据流设计

1. 客户端请求通过Nginx负载均衡器分发
2. API网关处理请求路由、认证和限流
3. 核心服务处理业务逻辑
4. 数据存储层提供数据持久化和检索
5. 扩展服务层提供智能体和协议支持

## 6. 组件隔离设计

为了确保良好的可扩展性和易于维护的架构设计，系统将核心组件进行了隔离：

### 6.1 数据库组件 (app/modules/database/)
包含所有数据库相关的配置、连接管理和客户端实现：
- **配置管理**：统一的数据库配置管理
- **连接管理**：数据库连接池和会话管理
- **客户端实现**：PostgreSQL、Redis、MinIO、Milvus的客户端封装

### 6.2 MCP协议模块 (app/modules/mcp/)
包含Model Coordination Protocol的实现：
- **协议处理**：MCP消息的解析和处理
- **模型管理**：模型发现和协调功能
- **扩展接口**：支持新的MCP功能扩展

### 6.3 Agent智能体功能 (app/modules/agents/)
包含Agent服务和相关功能：
- **Agent管理**：Agent的创建、配置和生命周期管理
- **任务调度**：任务分配和执行管理
- **状态监控**：Agent状态和性能监控

### 6.4 核心业务逻辑 (app/modules/core/)
包含系统的核心业务逻辑：
- **LLM服务**：大语言模型服务实现
- **启动管理**：应用启动和关闭处理

这种组件隔离设计确保了：
1. **独立开发**：各组件可以独立开发和测试
2. **易于维护**：组件之间的依赖关系清晰
3. **良好扩展性**：可以独立扩展各个组件
4. **故障隔离**：一个组件的问题不会影响其他组件